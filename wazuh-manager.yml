---
# Certificates generation
  - hosts: localhost
    vars_files:
      - "{{ playbook_dir }}/vars/wazuh-single.yml"
      - "{{ playbook_dir }}/vars/wazuh-secrets.yml"
    roles:
      - role: "{{ playbook_dir }}/roles/wazuh-ansible/wazuh-ansible/roles/wazuh/wazuh-indexer"
        perform_installation: false
    become: no
    #become_user: root
    vars:
      indexer_node_master: true
      instances:
        node1:
          name: "{{ indexer_node_name }}"      # Important: must be equal to indexer_node_name.
          ip: "{{ indexer_network_host }}"
          role: indexer
    tags:
      - generate-certs
# Single node
  - hosts: wazuh-master
    vars_files:
       - "{{ playbook_dir }}/vars/wazuh-single.yml"
    become: yes
    become_user: root
    roles:
      - role: "{{ playbook_dir }}/roles/wazuh-ansible/wazuh-ansible/roles/wazuh/wazuh-indexer"
      - role: "{{ playbook_dir }}/roles/wazuh-ansible/wazuh-ansible/roles/wazuh/ansible-wazuh-manager"
      - role: "{{ playbook_dir }}/roles/wazuh-ansible/wazuh-ansible/roles/wazuh/ansible-filebeat-oss"
      - role: "{{ playbook_dir }}/roles/wazuh-ansible/wazuh-ansible/roles/wazuh/wazuh-dashboard"
    vars:
      single_node: true
      minimum_master_nodes: 1
      indexer_node_master: true
      indexer_network_host: "{{ indexer_network_host }}"
      filebeat_node_name: "{{ indexer_node_name }}"
      filebeat_output_indexer_hosts:
      - "{{ indexer_network_host }}"
      instances:
        node1:
          name: "{{ indexer_node_name }}"       # Important: must be equal to indexer_node_name.
          ip: "{{ indexer_network_host }}"
          role: indexer
      ansible_shell_allow_world_readable_temp: true

      post_tasks:
        - name: Set http/s_proxy vars in ossec-init.conf for vulnerability detector
          blockinfile:
            path: "/var/ossec/etc/ossec.conf"
            state: present
            owner: root
            group: ossec
            block: |
              HTTPS_PROXY={{ http_proxy_url }}
              HTTP_PROXY={{ http_proxy_url }}
            backup: yes
          when: http_proxy_url is defined
          notify:
            - Restart wazuh

    handlers:
      - name: Restart wazuh
        service:
          name: wazuh-manager
          state: restarted

